<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙˆÙƒÙŠÙ„ Ø§Ù„ØªØ±Ø¨Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ ÙˆØ§Ù„Ù…Ø­Ø§ØµÙŠÙ„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Kufi+Arabic:wght@100..900&display=swap');
        
        body {
            font-family: 'Noto Kufi Arabic', 'Inter', sans-serif;
            background-color: #f8fbf8; 
            color: #1a2e31; 
        }
        .card {
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: transform 0.2s;
        }
        .log-area {
            /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹: Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙ…Ø¯Ø¯ Ù„ÙŠØºØ·ÙŠ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù…Ø±Ø­Ù„ØªÙŠÙ† 3 Ùˆ 4 */
            min-height: 480px; 
            background-color: #1a2e31; 
            color: #e2e8f0; 
            border: 1px solid #4ade80;
        }
        .report-area {
            min-height: 400px;
            background-color: #f0fdf4; 
            border: 1px solid #4ade80;
            color: #1a2e31; 
        }
        .loading-ring {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #10b981; 
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        
        <header class="text-center mb-10 p-6 rounded-xl bg-green-100 border border-green-300">
            <h1 class="text-3xl md:text-4xl font-extrabold text-green-700">ğŸŒ¿ ÙˆÙƒÙŠÙ„ Ø§Ù„ØªØ±Ø¨Ø© ÙˆØ§Ù„Ù…Ø­Ø§ØµÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ ğŸ”¬</h1>
            <p class="mt-2 text-lg text-gray-600">ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù… Ù„Ù„ØªØ±Ø¨Ø© ÙˆØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø· Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© Ù„Ù„Ù…Ø­Ø§ØµÙŠÙ„ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ©.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            
            <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">

                <div class="card p-6 rounded-xl">
                    <h2 class="text-xl font-bold mb-4 flex items-center text-green-700">
                        <i data-lucide="image" class="w-5 h-5 ml-2"></i> Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±Ø¨Ø© ÙˆØ§Ù„Ù…Ø³Ø§Ø­Ø©
                    </h2>
                    <label for="imageUpload" class="block text-sm font-medium text-gray-600 mb-2">ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„ØªØ±Ø¨Ø© (Ø§Ù„Ø¯Ø±ÙˆÙ†)</label>
                    <input type="file" id="imageUpload" class="w-full text-sm text-gray-600
                        file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0
                        file:text-sm file:font-semibold file:bg-green-600/20 file:text-green-700
                        hover:file:bg-green-600/30" onchange="handleImageUpload()">
                    <p id="imageStatus" class="mt-1 text-xs text-gray-500">âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©</p>

                    <label for="area_sqm" class="block text-sm font-medium text-gray-600 mt-4 mb-2">Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø­Ù‚Ù„ (Ù…ØªØ± Ù…Ø±Ø¨Ø¹)</label>
                    <input type="number" id="area_sqm" value="10000" min="1" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-green-500 focus:ring-green-500 text-left" dir="ltr" oninput="updateAppState('area_sqm', this.value)">
                </div>

                <div class="card p-6 rounded-xl">
                    <h2 class="text-xl font-bold mb-4 flex items-center text-green-700">
                        <i data-lucide="map-pin" class="w-5 h-5 ml-2"></i> Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ
                    </h2>
                    <label for="location_name" class="block text-sm font-medium text-gray-600 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù…Ø«Ø§Ù„: Ouargla, Algeria)</label>
                    <input type="text" id="location_name" value="Ouargla, Algeria" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-green-500 focus:ring-green-500 text-left" dir="ltr" oninput="updateAppState('location_name', this.value)">
                    
                    <label for="prev_crops" class="block text-sm font-medium text-gray-600 mt-4 mb-2">Ù…Ø­Ø§ØµÙŠÙ„ Ø³Ø§Ø¨Ù‚Ø© (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„)</label>
                    <input type="text" id="prev_crops" value="ØªÙ…Ø±, Ù‚Ù…Ø­_ØµÙ„Ø¨" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-green-500 focus:ring-green-500" oninput="updateAppState('prev_crops_str', this.value)">
                </div>
            
                <div class="card p-6 rounded-xl">
                    <h2 class="text-xl font-bold mb-4 flex items-center text-green-700">
                        <i data-lucide="award" class="w-5 h-5 ml-2"></i> Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„Ø£ÙØ¶Ù„ÙŠØ© ÙˆØ§Ù„Ù…Ø­ØµÙˆÙ„ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù
                    </h2 >
                    <label for="farmer_pref" class="block text-sm font-medium text-gray-600 mb-2">Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„ÙÙ„Ø§Ø­</label>
                    <select id="farmer_pref" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-green-500 focus:ring-green-500" onchange="updateAppState('farmer_pref', this.value)">
                        <option value="high_profit">Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ø§Ù„ÙŠØ©</option>
                        <option value="low_water">Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ù…Ø§Ø¡ Ù…Ù†Ø®ÙØ¶</option>
                        <option value="improve_efficiency">ØªØ­Ø³ÙŠÙ† ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡</option>
                        <option value="none" selected>Ù„Ø§ Ø´ÙŠØ¡ (Ù…Ø¹Ø§ÙŠÙŠØ± Ø¹Ø§Ù…Ø©)</option>
                    </select>

                    <label for="desired_crop" class="block text-sm font-medium text-gray-600 mt-4 mb-2">Ø§Ù„Ù…Ø­ØµÙˆÙ„ Ø§Ù„Ù…Ø±ØºÙˆØ¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="text" id="desired_crop" value="" placeholder="Ù…Ø«Ù„: Ø²ÙŠØªÙˆÙ†" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-green-500 focus:ring-green-500" oninput="updateAppState('desired_crop', this.value)">
                </div>
                
                <div class="card p-6 rounded-xl bg-yellow-100/30 border-yellow-300/80">
                    <h2 class="text-xl font-bold mb-4 flex items-center text-yellow-700">
                        <i data-lucide="clock-history" class="w-5 h-5 ml-2"></i> Ø§Ù„Ø®Ø·ÙˆØ© 4: ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                    </h2>
                    <p class="text-sm text-gray-600 mb-3">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ³Ù… Ø³Ø§Ø¨Ù‚ Ù„Ø²ÙŠØ§Ø¯Ø© Ø¯Ù‚Ø© Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©.</p>
                    <button onclick="promptHistoricalData()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200" id="btn-historical">
                        ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚
                    </button>
                    <p id="historicalStatus" class="mt-2 text-xs text-gray-500 text-center">Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ§Ø±ÙŠØ®ÙŠØ©.</p>
                </div>
            </div>
            
            <div class="lg:col-span-1">
                
                <div class="card p-6 rounded-xl h-full flex flex-col">
                    <h2 class="text-xl font-bold mb-3 flex items-center text-gray-700">
                        <i data-lucide="square-terminal" class="w-5 h-5 ml-2"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                    </h2>
                    <div id="logOutput" class="log-area p-3 rounded-lg overflow-y-scroll text-sm whitespace-pre-wrap text-left font-mono flex-grow">
                        <p class="text-green-400">
                            > ØªÙ… ØªÙ‡ÙŠØ¦Ø© ÙˆÙƒÙŠÙ„ Ø§Ù„ØªØ±Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­.
                        </p>
                        <p class="text-blue-400">
                            > ğŸŒ ØªÙ… Ø±Ø¨Ø· Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø®Ø§Ø¯Ù… Flask API (web_agent.py).
                        </p>
                    </div>
                </div>
            </div>

        </div>
        
        <div class="card p-6 rounded-xl lg:col-span-3 mb-6">
            <h2 class="text-xl font-bold mb-4 flex items-center text-green-700">
                <i data-lucide="layers-3" class="w-5 h-5 ml-2"></i> Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ ÙˆØ§Ù„ØªÙˆØµÙŠØ©
            </h2>
            <button onclick="analyzeSoil()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 mb-4" id="btn-analyze">
                Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨Ø© ÙˆØªÙ‚Ø¯ÙŠÙ… Ø§Ù„ØªÙˆØµÙŠØ©
            </button>
            
            <div id="recommendation-results" class="hidden">
                <label for="selected_crop" class="block text-sm font-medium text-gray-600 mb-2">Ø§Ù„Ù…Ø­ØµÙˆÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­ (Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø·Ø©)</label>
                <select id="selected_crop" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-green-500 focus:ring-green-500" onchange="updateAppState('selected_crop', this.value)">
                    <option value="">-- Ø§Ø®ØªØ± Ù…Ø­ØµÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª --</option>
                </select>
                <p id="suitability-score" class="mt-2 text-sm font-semibold text-gray-600"></p>
            </div>
        </div>

        <div class="card p-6 rounded-xl bg-yellow-100/30 border-yellow-300/80 lg:col-span-3 mb-6">
            <h2 class="text-xl font-bold mb-4 flex items-center text-yellow-700">
                <i data-lucide="clipboard-list" class="w-5 h-5 ml-2"></i> Ø§Ù„Ø®Ø·ÙˆØ© 6: ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„ØªÙƒØ§Ù„ÙŠÙ
            </h2>
            <button onclick="generateDetailedPlan()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 disabled:bg-gray-500" id="btn-generate-plan" disabled>
                ØªÙˆÙ„ÙŠØ¯ ÙˆØªØµØ¯ÙŠØ± Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ø±Ø¨Ø­
            </button>
        </div>
        
        <div class="card p-6 rounded-xl report-area lg:col-span-3">
            <h2 class="text-xl font-bold mb-3 flex items-center text-gray-700">
                <i data-lucide="file-text" class="w-5 h-5 ml-2"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
            </h2>
            <pre id="detailedReportOutput" class="report-area p-3 rounded-lg overflow-auto text-sm bg-gray-100 border border-gray-300">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...</pre>
            
            <div id="satisfaction-rating" class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg text-center hidden">
                <p class="text-lg font-bold text-green-700 mb-2">Ù†Ø³Ø¨Ø© Ø±Ø¶Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„</p>
                <div class="flex justify-center space-x-4 space-x-reverse">
                    <button onclick="rateApp(5)" class="text-3xl hover:scale-110 transition duration-200" title="Ø±Ø§Ø¶Ù Ø¬Ø¯Ø§Ù‹">â­</button>
                    <button onclick="rateApp(4)" class="text-3xl hover:scale-110 transition duration-200" title="Ø±Ø§Ø¶Ù">â­</button>
                    <button onclick="rateApp(3)" class="text-3xl hover:scale-110 transition duration-200" title="Ù…Ø­Ø§ÙŠØ¯">â­</button>
                    <button onclick="rateApp(2)" class="text-3xl hover:scale-110 transition duration-200" title="ØºÙŠØ± Ø±Ø§Ø¶Ù">â­</button>
                    <button onclick="rateApp(1)" class="text-3xl hover:scale-110 transition duration-200" title="ØºÙŠØ± Ø±Ø§Ø¶Ù Ø¬Ø¯Ø§Ù‹">â­</button>
                </div>
                <p id="rating-message" class="mt-2 text-sm text-gray-600"></p>
            </div>
        </div>

    </div>
    
    <div id="modal-container"></div>


    <script>
        // -------------------- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ«ÙˆØ§Ø¨Øª --------------------
        const BASE_API_URL = 'http://127.0.0.1:5000';
        
        // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø°Ø§ÙƒØ±Ø©) - ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ù†ØªØ§Ø¦Ø¬ API Ù…Ø¤Ù‚ØªØ§Ù‹ Ù‡Ù†Ø§
        let appState = {
            image_path: null,
            soil_type: null,
            recommendations: [],
            area_sqm: 10000,
            selected_crop: null, 
            historical_analysis: null,
            prev_crops_str: "ØªÙ…Ø±, Ù‚Ù…Ø­_ØµÙ„Ø¨",
            location_name: "Ouargla, Algeria",
            farmer_pref: "high_profit",
            desired_crop: ""
        };

        // -------------------- Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… --------------------

        function log(message, color = "normal") {
            const logElement = document.getElementById('logOutput');
            const colorMap = {
                "normal": "text-gray-300", "error": "text-red-400", 
                "success": "text-green-400", "warning": "text-yellow-400", 
                "info": "text-blue-400", "detail": "text-purple-400"
            };
            
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            
            const p = document.createElement('p');
            p.className = `${colorMap[color] || colorMap['normal']}`;
            p.textContent = `[${time}] - ${message}`;
            
            logElement.appendChild(p);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        function showModal(title, content, onSave) {
            const modalContainer = document.getElementById('modal-container');
            
            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white p-6 rounded-xl w-full max-w-md border border-gray-300 shadow-2xl">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">${title}</h3>
                        <div class="mb-4 text-gray-600">${content}</div>
                        <div class="flex justify-end space-x-2 space-x-reverse"> 
                            <button id="modal-save" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">Ø­ÙØ¸ ÙˆØªØ­Ù„ÙŠÙ„</button>
                            <button id="modal-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                </div>
            `;
            
            const modalRoot = modalContainer.querySelector('.fixed.inset-0'); 
            const saveButton = modalRoot.querySelector('#modal-save');
            const cancelButton = modalRoot.querySelector('#modal-cancel');

            cancelButton.onclick = () => {
                modalContainer.innerHTML = '';
                log("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©.", "warning");
            };

            saveButton.onclick = () => {
                const values = {};
                modalRoot.querySelectorAll('input').forEach(input => {
                    values[input.id.replace('modal-', '')] = input.value;
                });
                onSave(values);
                modalContainer.innerHTML = ''; 
            };
        }

        function rateApp(rating) {
            const ratingMessage = document.getElementById('rating-message');
            let message = "";
            switch(rating) {
                case 5: message = "Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ! ÙŠØ³Ø¹Ø¯Ù†Ø§ Ø¬Ø¯Ø§Ù‹ Ø£Ù†Ùƒ Ø±Ø§Ø¶Ù Ø¹Ù† Ø§Ù„Ø®Ø¯Ù…Ø©. â­â­â­â­â­"; break;
                case 4: message = "Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ. Ù†Ø­Ù† Ù†Ø¹Ù…Ù„ Ø¬Ø§Ù‡Ø¯ÙŠÙ† Ù„ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨ØªÙƒ."; break;
                case 3: message = "Ù†Ù‚Ø¯Ø± Ø±Ø£ÙŠÙƒ. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø£Ù† Ù†ÙƒÙˆÙ† Ø£ÙØ¶Ù„ØŸ"; break;
                case 2: message = "Ù†Ø¹ØªØ°Ø± Ù„Ø°Ù„Ùƒ. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙ†Ø§ ÙÙŠ Ø§Ù„ØªØ­Ø³ÙŠÙ†."; break;
                case 1: message = "Ù†Ø¹ØªØ°Ø± Ø¨Ø´Ø¯Ø©. Ø³Ù†Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø§Øª Ø¨Ø³Ø±Ø¹Ø©."; break;
            }
            ratingMessage.textContent = message;
            
            const stars = document.querySelectorAll('#satisfaction-rating button');
            stars.forEach((star, index) => {
                const starIndex = 5 - index; 
                if (starIndex <= rating) {
                    star.style.opacity = '1';
                } else {
                    star.style.opacity = '0.3'; 
                }
            });
        }


        // -------------------- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ API --------------------

        async function promptHistoricalData() {
            showModal(
                "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ",
                `
                <p class="mb-4 text-gray-600">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ³Ù… Ø²Ø±Ø§Ø¹ÙŠ Ø³Ø§Ø¨Ù‚ Ù„Ø²ÙŠØ§Ø¯Ø© Ø¯Ù‚Ø© Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©.</p>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø­ØµÙˆÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø§Ù„Ø°ÙŠ ØªÙ… Ø²Ø±Ø¹Ù‡ (Ù…Ø«Ø§Ù„: ØªÙ…Ø±):</label>
                <input type="text" id="modal-crop" value="ØªÙ…Ø±" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-yellow-500 mb-3 text-left" dir="ltr">
                <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ (ÙƒØºÙ…):</label>
                <input type="number" id="modal-yield" value="7500" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-yellow-500 mb-3 text-left" dir="ltr">
                <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Â³):</label>
                <input type="number" id="modal-water" value="4800" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-yellow-500 mb-3 text-left" dir="ltr">
                <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„ÙØ¹Ù„ÙŠ (Ø¯.Ø¬):</label>
                <input type="number" id="modal-profit" value="2500000" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300 focus:border-yellow-500 mb-3 text-left" dir="ltr">
                `,
                async (values) => {
                    const yieldVal = parseFloat(values.yield);
                    if (!values.crop || yieldVal <= 0) {
                        log("âŒ ÙØ´Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø­ØµÙˆÙ„ ÙˆØ§Ù„Ù…Ø±Ø¯ÙˆØ¯.", "error");
                        document.getElementById('historicalStatus').textContent = `âŒ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.`;
                        return;
                    }

                    const btn = document.getElementById('btn-historical');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = `<div class="loading-ring ml-2"></div> Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®...`;
                    btn.disabled = true;

                    const payload = {
                        crop: values.crop,
                        area_sqm: appState.area_sqm,
                        actual_yield: yieldVal,
                        actual_water: parseFloat(values.water) || 0,
                        actual_profit: parseFloat(values.profit) || 0
                    };

                    try {
                        const response = await axios.post(`${BASE_API_URL}/api/analyze_historical`, payload); 
                        appState.historical_analysis = response.data;
                        document.getElementById('historicalStatus').textContent = `âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„: ${values.crop}.`;
                        log(`ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ Ù„Ù€ ${values.crop}.`, "success");
                        log(appState.historical_analysis.message, "detail");

                    } catch (error) {
                        log(`âŒ Ø®Ø·Ø£ ÙÙŠ API ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®: ${error.response?.status} - ${error.response?.data?.error || error.message}`, "error");
                        document.getElementById('historicalStatus').textContent = `âŒ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©.`;
                        appState.historical_analysis = null;
                    } finally {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                }
            );
        }

        async function analyzeSoil() {
            log("--- Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ„ÙŠ Ø¹Ø¨Ø± API ---", "info");
            const btn = document.getElementById('btn-analyze');
            const resultsDiv = document.getElementById('recommendation-results');
            btn.disabled = true;
            btn.innerHTML = `<div class="loading-ring ml-2"></div> Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨Ø© ÙˆØ§Ù„Ù…Ø­Ø§ØµÙŠÙ„...`;
            resultsDiv.classList.add('hidden');
            document.getElementById('btn-generate-plan').disabled = true;
            document.getElementById('satisfaction-rating').classList.add('hidden'); 

            const payload = {
                image_path: appState.image_path,
                area_sqm: appState.area_sqm,
                prev_crops_str: appState.prev_crops_str,
                farmer_pref: appState.farmer_pref,
                desired_crop: appState.desired_crop,
            };

            try {
                const response = await axios.post(`${BASE_API_URL}/api/analyze_soil`, payload); 
                const data = response.data;
                
                appState.soil_type = data.soil_type;
                appState.recommendations = data.recommendations;
                
                log(`âœ… Ø§ÙƒØªÙ…Ù„ ØªØ­Ù„ÙŠÙ„ API. Ù†ÙˆØ¹ Ø§Ù„ØªØ±Ø¨Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${data.soil_type}.`, "success");

                const select = document.getElementById('selected_crop');
                select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ø­ØµÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª --</option>';
                
                const topRecommendations = data.recommendations.slice(0, 5);
                topRecommendations.forEach((item, index) => {
                    const option = document.createElement('option');
                    option.value = item.crop;
                    option.textContent = `${index + 1}. ${item.crop} (${item.score.toFixed(1)}% Ù…Ù„Ø§Ø¡Ù…Ø©)`;
                    select.appendChild(option);
                });
                
                if (topRecommendations.length > 0) {
                    appState.selected_crop = topRecommendations[0].crop;
                    select.value = topRecommendations[0].crop;
                    document.getElementById('suitability-score').textContent = 
                        `Ø§Ù„ØªØ±Ø¨Ø©: ${appState.soil_type} | Ø§Ù„Ù…Ø­ØµÙˆÙ„ Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡: ${appState.selected_crop} (${topRecommendations[0].score.toFixed(1)}%)`;
                    document.getElementById('btn-generate-plan').disabled = false;
                    resultsDiv.classList.remove('hidden');
                } else {
                    appState.selected_crop = null;
                    document.getElementById('suitability-score').textContent = `Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙˆØµÙŠØ§Øª Ù…Ù„Ø§Ø¦Ù…Ø©.`;
                }

                log("--- Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ„ÙŠ Ø¨Ù†Ø¬Ø§Ø­ ---", "success");

            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ API Ø§Ù„ØªØ­Ù„ÙŠÙ„: ${error.response?.status} - ${error.response?.data?.error || error.message}`, "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = `Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨Ø© ÙˆØªÙ‚Ø¯ÙŠÙ… Ø§Ù„ØªÙˆØµÙŠØ©`;
            }
        }

        async function generateDetailedPlan() {
            if (!appState.selected_crop) {
                log("âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­ØµÙˆÙ„ Ù…Ù‚ØªØ±Ø­ Ø£ÙˆÙ„Ø§Ù‹.", "error");
                return;
            }
            
            log(`--- Ø¨Ø¯Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© Ù„Ù…Ø­ØµÙˆÙ„ ${appState.selected_crop} Ø¹Ø¨Ø± API ---`, "info");
            const btn = document.getElementById('btn-generate-plan');
            const reportOutput = document.getElementById('detailedReportOutput');
            
            btn.disabled = true;
            btn.innerHTML = `<div class="loading-ring ml-2"></div> Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...`;
            reportOutput.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø²Ø±Ø§Ø¹ÙŠØ©...";

            const payload = {
                selected_crop: appState.selected_crop,
                area_sqm: appState.area_sqm,
                soil_type: appState.soil_type,
                location_name: appState.location_name,
                recommendations: appState.recommendations,
                farmer_pref_display: document.getElementById('farmer_pref').options[document.getElementById('farmer_pref').selectedIndex].text
            };

            try {
                const response = await axios.post(`${BASE_API_URL}/api/generate_plan`, payload); 
                const reportText = response.data.report;

                reportOutput.textContent = reportText.trim();
                log("âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±.", "success");
                document.getElementById('satisfaction-rating').classList.remove('hidden'); 

                // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ù†Ø³Ø®
                const copyButton = document.createElement('button');
                copyButton.className = 'w-full mt-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center';
                copyButton.innerHTML = `<i data-lucide="copy" class="w-4 h-4 ml-2"></i> Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±`;
                copyButton.onclick = () => {
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = reportOutput.textContent;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextArea);
                    log("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.", "success");
                    lucide.createIcons();
                };
                
                const reportContainer = document.getElementById('detailedReportOutput').parentNode;
                const existingCopyButton = reportContainer.querySelector('.copy-report-btn');
                if (existingCopyButton) {
                    existingCopyButton.remove();
                }
                copyButton.className += ' copy-report-btn';
                reportContainer.insertBefore(copyButton, document.getElementById('satisfaction-rating'));
                lucide.createIcons();


            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ API ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø©: ${error.response?.status} - ${error.response?.data?.error || error.message}`, "error");
                reportOutput.textContent = `Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${error.response?.data?.error || 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….'}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = `ØªÙˆÙ„ÙŠØ¯ ÙˆØªØµØ¯ÙŠØ± Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ø±Ø¨Ø­`;
            }
        }

        // -------------------- Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Initialization) --------------------

        document.addEventListener("DOMContentLoaded", () => {
            lucide.createIcons();
            initializeApp();
        });

        function initializeApp() {
             // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            appState.area_sqm = parseFloat(document.getElementById('area_sqm').value);
            appState.location_name = document.getElementById('location_name').value;
            appState.prev_crops_str = document.getElementById('prev_crops').value;
            appState.farmer_pref = document.getElementById('farmer_pref').value;
            appState.desired_crop = document.getElementById('desired_crop').value;
            document.getElementById('selected_crop').addEventListener('change', (e) => updateAppState('selected_crop', e.target.value));
        }

        function updateAppState(key, value) {
            if (key === 'area_sqm') {
                appState[key] = parseFloat(value) || 0;
            } else {
                appState[key] = value;
            }
            
            if (key === 'selected_crop') {
                const selected = appState.recommendations.find(r => r.crop === value);
                if (selected) {
                    document.getElementById('suitability-score').textContent = 
                        `Ø§Ù„ØªØ±Ø¨Ø©: ${appState.soil_type} | Ø§Ù„Ù…Ø­ØµÙˆÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø±: ${selected.crop} (${selected.score.toFixed(1)}%)`;
                }
                document.getElementById('btn-generate-plan').disabled = !value;
            }
        }
        
        function handleImageUpload() {
            const fileInput = document.getElementById('imageUpload');
            const imageStatus = document.getElementById('imageStatus');
            if (fileInput.files.length > 0) {
                const fileName = fileInput.files[0].name;
                // ÙŠØ±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙÙ‚Ø· Ø¥Ù„Ù‰ Flask. Flask Ø³ÙŠØ¶ÙŠÙ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (BASE_IMAGE_DIR)
                appState.image_path = fileName; 
                imageStatus.innerHTML = `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: <span class="text-green-600">${fileName}</span>`;
                log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: ${fileName}.`, "success");
            } else {
                appState.image_path = null;
                imageStatus.innerHTML = `âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©`;
            }
        }
    </script>
</body>
</html>
